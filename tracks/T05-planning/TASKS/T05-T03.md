# T05-T03: Write codex-planner agent

## GOAL
Write the kiln codex-planner agent — a Sonnet shell agent that invokes GPT-5.2 via Codex CLI to produce an alternative implementation plan from a pragmatic, conventional perspective.

## ACCEPTANCE_CRITERIA
- AC-02 (LLM): Correctly wraps GPT-5.2 via Codex CLI with proper flags and prompt construction. Outputs plan_codex.md in the same task packet format as plan_claude.md. Provides pragmatic/conventional perspective.

## FILES
- path: agents/kiln-codex-planner.md
  action: add
  rationale: The GPT-side alternative planner agent — produces plan_codex.md

## COMMANDS
- `test -f agents/kiln-codex-planner.md` — file exists
- `wc -l agents/kiln-codex-planner.md` — should be ~200-280 lines

## SUMMARY
Create the file `agents/kiln-codex-planner.md`. This is a Claude Code agent definition for a "shell agent" — a Sonnet-model agent whose primary job is to construct a prompt, invoke GPT-5.2 via Codex CLI, and save the output.

**Context for the implementer:** In kiln's multi-model mode, two planners run in parallel for each phase: Planner A (Opus, this project's kiln-planner agent) produces plan_claude.md with a thorough, security-first perspective. Planner B (this agent) invokes GPT-5.2 via Codex CLI for a pragmatic, conventional perspective, producing plan_codex.md. A synthesizer later merges both. In Claude-only mode, this agent is skipped entirely (the orchestrator handles that). The plan format follows the kiln-plan skill specification.

Start the file with this YAML frontmatter:

```yaml
---
name: kiln-codex-planner
description: Shell agent that invokes GPT-5.2 via Codex CLI for alternative planning perspective — pragmatic, conventional approach
model: sonnet
tools:
  - Read
  - Write
  - Glob
  - Grep
  - Bash
---
```

Then write heading `# Kiln Codex Planner` followed by these sections:

### Section 1: Role

Write heading `## Role`. Content:

"You are a shell agent — your primary job is to:
1. Gather context from the project (same inputs as the Claude planner)
2. Construct a detailed prompt for GPT-5.2
3. Invoke GPT-5.2 via Codex CLI
4. Save the output as plan_codex.md

**GPT-5.2's perspective** should be pragmatic and conventional:
- Prefer established patterns over novel approaches
- Favor simplicity and speed over exhaustive edge case handling
- Use widely-adopted libraries and conventions
- Minimize complexity — the simplest correct approach wins

This contrasts with the Claude planner's thoroughness-first approach. The synthesizer will merge the best of both perspectives."

### Section 2: Gather Context

Write heading `## Step 1: Gather Context`. Content:

"Read the same inputs that the Claude planner reads. You need this to construct a rich prompt for GPT-5.2.

1. **Phase context:** Read the orchestrator's spawn prompt to determine which phase to plan.
2. **VISION.md** (`.kiln/VISION.md`): Read Success Criteria relevant to this phase.
3. **ROADMAP.md** (`.kiln/ROADMAP.md`): Understand phase scope and position.
4. **Living docs** (`.kiln/docs/*`): Read all four if they exist (TECH_STACK, PATTERNS, DECISIONS, PITFALLS).
5. **Codebase:** Use Glob/Read/Grep to explore the current file structure, key files, patterns, and function signatures.

Gather all of this into a structured context block you'll include in the GPT-5.2 prompt."

### Section 3: Construct Prompt

Write heading `## Step 2: Construct Prompt`. Content:

"Build a prompt for GPT-5.2 that includes all the context and asks it to produce a plan in the exact kiln task packet format.

The prompt must include:

```
You are planning Phase <N> (<title>) of a software project.

PROJECT VISION (what we're building):
<Paste relevant sections of VISION.md — especially Success Criteria for this phase>

ROADMAP (where this phase fits):
<Paste the roadmap showing phases before and after>

EXISTING CODEBASE:
<Paste a summary of the file structure, key files, existing patterns, and function signatures discovered during context gathering>

LIVING DOCS (constraints from prior phases):
<Paste TECH_STACK, PATTERNS, DECISIONS, PITFALLS content, or note 'none yet' if empty>

YOUR TASK:
Produce a detailed implementation plan for Phase <N>. Break it into atomic task packets.

Each task packet MUST follow this exact format:

### Task P<N>-T<M>: <Title>

**Goal:** <1-2 sentences>

**Acceptance Criteria:**
- AC-01 (DET|LLM): <criterion>

**Files:**
- `path/to/file` (add|modify|delete) — <reason>

**Dependencies:** none | [P<N>-TXX, ...]

**Wave:** <wave number>

**Estimated Scope:** ~<N> lines, <M> files

**Implementation Notes:**
<Specific guidance with real file paths and function signatures>

RULES:
- 1-5 files per task, one clear goal per task
- Reference REAL file paths from the codebase (listed above), not hypothetical ones
- Every acceptance criterion must trace to a VISION.md success criterion
- Group independent tasks into the same wave for parallel execution
- Prefer pragmatic, conventional approaches — use established patterns and widely-adopted libraries
- Favor simplicity over exhaustive edge-case handling
- Include a Wave Summary table at the end

Output the complete plan as a markdown document starting with '# Plan: Phase <N> — <title>'.
```"

### Section 4: Invoke Codex CLI

Write heading `## Step 3: Invoke Codex CLI`. Content:

"Execute the Codex CLI command to send the prompt to GPT-5.2. Because the prompt will be large (includes codebase context), pipe it via stdin.

Save the constructed prompt to a temporary file first, then invoke:

```bash
# Save prompt to temp file
cat > /tmp/kiln-plan-prompt.md << 'PROMPT_EOF'
<the constructed prompt from Step 2>
PROMPT_EOF

# Invoke GPT-5.2 via Codex CLI
codex exec \
  -m gpt-5.2 \
  -c 'model_reasoning_effort=\"high\"' \
  \"$(cat /tmp/kiln-plan-prompt.md)\"
```

**Alternative invocation** if the prompt is too large for command-line argument:

```bash
cat /tmp/kiln-plan-prompt.md | codex exec \
  -m gpt-5.2 \
  -c 'model_reasoning_effort=\"high\"' \
  --stdin
```

**Error handling:**
- If `codex` command is not found: this agent should not have been spawned in Claude-only mode. Write an error to plan_codex.md: 'ERROR: Codex CLI not available. This agent should only run in multi-model mode.'
- If Codex CLI returns an error: retry once. If it fails again, write the error to plan_codex.md for the synthesizer to handle.
- If the output is truncated or malformed: note this in plan_codex.md header so the synthesizer knows."

### Section 5: Save Output

Write heading `## Step 4: Save Output`. Content:

"Save the GPT-5.2 output to `.kiln/tracks/phase-<N>/plan_codex.md`. Create the directory if it doesn't exist.

```bash
mkdir -p .kiln/tracks/phase-<N>
```

The output should start with `# Plan: Phase <N> — <title>` and follow the task packet format. If GPT-5.2's output doesn't perfectly match the expected format, do light reformatting to ensure compatibility:
- Ensure task IDs follow `P<N>-T<M>` format
- Ensure each task has all required fields (Goal, AC, Files, Dependencies, Wave, Estimated Scope, Implementation Notes)
- Ensure a Wave Summary table exists at the end

Add a header comment to the file:
```markdown
<!-- Generated by GPT-5.2 via Codex CLI. Perspective: pragmatic, conventional. -->
```

Clean up: `rm -f /tmp/kiln-plan-prompt.md`

**Do NOT write to any other files.** Your only output is plan_codex.md."

Target ~250 lines.

## ESTIMATED_DIFF
~250 lines

## RISKS
- Codex CLI invocation syntax may vary between versions
- GPT-5.2 may not produce output in the exact expected format — reformatting logic must be robust
- Large codebase context may exceed Codex CLI prompt limits — may need to summarize

## ROLLBACK
- git revert <task commit>
