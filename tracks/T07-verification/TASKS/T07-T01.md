# T07-T01: Write E2E verifier agent

## GOAL
Write the kiln E2E verifier agent — a Sonnet-based agent that generates and executes end-to-end user journey tests per project type. It runs after task execution, detecting the project's start command, launching the app, generating tests from acceptance criteria, executing them (new + cumulative regression), and categorizing any failures into correction tasks.

## ACCEPTANCE_CRITERIA
- AC-01 (LLM): Agent generates user journey tests (not unit tests) appropriate to the detected project type
- AC-02 (LLM): Handles 4 project types: web-ui (Playwright), api-server (HTTP), cli-tool (subprocess), library (import)
- AC-05 (LLM): Failure categorization covers: code bug, integration gap, missing functionality, config issue
- AC-06 (DET): File exists at `agents/kiln-e2e-verifier.md` with valid YAML frontmatter

## FILES
- path: agents/kiln-e2e-verifier.md
  action: add
  rationale: The E2E verifier agent — test generation + execution for runtime verification

## COMMANDS
- `test -f agents/kiln-e2e-verifier.md` — file exists
- `head -1 agents/kiln-e2e-verifier.md | grep -q "^---"` — has YAML frontmatter
- `wc -l agents/kiln-e2e-verifier.md` — should be ~300-400 lines

## SUMMARY
Create the file `agents/kiln-e2e-verifier.md`. This is a Claude Code agent definition — a markdown document with YAML frontmatter that defines the agent's role, model, tools, and behavioral rules.

**Context for the implementer:** Kiln is a multi-model orchestration workflow for Claude Code. The E2E verifier runs AFTER task execution (the execute stage) to validate that implemented features actually work at runtime. It is spawned by the kiln orchestrator (see `agents/kiln-orchestrator.md`) and references the kiln-e2e skill (see T07-T02) for test generation patterns. It reads acceptance criteria from `.kiln/tracks/phase-N/PLAN.md` and writes results to `.kiln/tracks/phase-N/e2e-results.md`. The E2E verifier is the RUNTIME quality gate — it actually starts the application and interacts with it.

Start the file with this YAML frontmatter:

```yaml
---
name: kiln-e2e-verifier
description: End-to-end test generation and execution — validates runtime behavior through user journey tests
model: sonnet
tools:
  - Read
  - Write
  - Edit
  - Bash
  - Glob
  - Grep
---
```

Then write heading `# Kiln E2E Verifier` followed by these sections:

### Section 1: Role
Write heading `## Role`. Define the E2E verifier as:
- A Sonnet-based test generation and execution agent
- Generates user journey tests (NOT unit tests) — tests that exercise the application the way a real user would
- 4 phases: environment setup, test generation, execution (new + regression), teardown
- Only writes to `.kiln/` directory and `tests/e2e/` directory
- References kiln-core for coordination contracts and kiln-e2e skill for test generation patterns
- Reads `.kiln/config.json` for project type and tooling configuration

### Section 2: Phase A — Environment Setup
Write heading `## Phase A: Environment Setup`. Content should cover:
- Read `.kiln/config.json` to get `projectType` and `tooling.startCommand`
- Read `.kiln/tracks/phase-N/PLAN.md` to get acceptance criteria for current phase
- Determine test approach based on project type:
  - `web-ui`: Install Playwright if not present, configure browser launch
  - `api-server`: Verify test HTTP client available (native fetch or curl)
  - `cli-tool`: Verify the CLI binary/script is accessible
  - `library`: Verify the library can be imported
- Start the application using `tooling.startCommand` from config
- Wait for ready signal with configurable timeout (default 30s from `preferences.e2eTimeout`)
- Ready detection: HTTP health check for web/api, process exit code for CLI, import success for library
- If startup fails: categorize as `config issue`, write failure to e2e-results.md, halt

### Section 3: Phase B — Test Generation
Write heading `## Phase B: Test Generation`. Content should cover:
- Read acceptance criteria from PLAN.md for the current phase
- For EACH acceptance criterion, generate a user journey test
- Reference the kiln-e2e skill for project-type-specific patterns:
  - Web UI: Playwright tests — navigate, click, fill forms, assert visible text/elements
  - API: HTTP request sequences — CRUD operations, validate response status/body
  - CLI: subprocess invocations — invoke with args, verify stdout/stderr/exit code
  - Library: import and call tests — require module, call functions, verify return values
- Tests must be JOURNEYS, not assertions:
  - GOOD: "User signs up, logs in, creates a project, sees project in dashboard"
  - BAD: "signup() returns true"
- Write generated tests to `tests/e2e/phase-N/` directory
- Also load ALL prior phase tests from `tests/e2e/phase-*/` for regression

### Section 4: Phase C — Execution
Write heading `## Phase C: Test Execution`. Content should cover:
- Execute new tests (current phase)
- Execute cumulative regression tests (all prior phases)
- Capture results: pass/fail per test, stdout/stderr, screenshots (web-ui)
- On failure, categorize each failure:
  - `code-bug`: Implementation doesn't match expected behavior
  - `integration-gap`: Components don't connect properly
  - `missing-functionality`: Feature not implemented at all
  - `config-issue`: Environment, startup, or tooling problem
- For each failure, generate a correction task packet:
  - Goal: what needs to be fixed
  - File hints: which files likely need changes
  - Error context: the actual error message/screenshot
- Write results to `.kiln/tracks/phase-N/e2e-results.md` using the `e2e-result` sentinel schema from kiln-core:
  ```yaml
  sentinel: e2e-result
  phase: N
  status: pass|fail
  suite: new|regression|both
  environment: {projectType, startCommand}
  summary: "X passed, Y failed"
  timestamp: ISO-8601
  failed_tests: [...]
  ```
- Correction cycle tracking: max 3 cycles. On each cycle, append context from previous failure but never weaken acceptance criteria.

### Section 5: Phase D — Teardown
Write heading `## Phase D: Teardown`. Content should cover:
- Stop the application (kill the process started in Phase A)
- Save test files to `tests/e2e/phase-N/` (these become the regression suite)
- Commit E2E tests: `git add tests/e2e/ && git commit -m "phase-N: add E2E tests"`
- Clean up any temporary files or browser instances

### Section 6: Output Files
Write heading `## Output Files`. List:
- `.kiln/tracks/phase-N/e2e-results.md` — test results with sentinel block (main output)
- `tests/e2e/phase-N/*.test.*` — generated test files (cumulative regression suite)
- Correction task packets (embedded in e2e-results.md when failures exist)

### Section 7: Error Escalation
Write heading `## Error Escalation`. Reference kiln-core error escalation:
- Max 3 E2E correction cycles
- On cycle exhaustion: HALT, save full error context to `.kiln/tracks/phase-N/artifacts/`
- Include: commands-run.md, logs, repro-steps.md, attempt-history.md
- Report to orchestrator with actionable summary

Target ~350 lines.

## ESTIMATED_DIFF
~350 lines

## RISKS
- E2E test generation quality depends on acceptance criteria quality from planning
- Startup timeout may need tuning per project type
- Playwright install may fail in restricted environments

## ROLLBACK
- git revert <task commit>
