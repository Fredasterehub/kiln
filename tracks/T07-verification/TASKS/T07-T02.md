# T07-T02: Write E2E skill

## GOAL
Write the kiln E2E skill — the test generation patterns and protocols referenced by the kiln-e2e-verifier agent. This skill defines project-type-specific test generation templates, user journey test format, startup detection, screenshot capture, and regression suite growth protocol.

## ACCEPTANCE_CRITERIA
- AC-01 (LLM): Test patterns defined for all 4 project types: web-ui (Playwright), api-server (HTTP), cli-tool (subprocess), library (import)
- AC-02 (LLM): Tests follow user journey format (end-to-end flows, not isolated assertions)
- AC-06 (DET): File exists at `skills/kiln-e2e/kiln-e2e.md` with valid YAML frontmatter
- AC-09 (LLM): Startup timeout detection and configuration documented
- AC-10 (LLM): Regression suite growth protocol defined

## FILES
- path: skills/kiln-e2e/kiln-e2e.md
  action: add
  rationale: Test generation patterns and E2E protocols for the kiln-e2e-verifier agent

## COMMANDS
- `test -f skills/kiln-e2e/kiln-e2e.md` — file exists
- `head -1 skills/kiln-e2e/kiln-e2e.md | grep -q "^---"` — has YAML frontmatter
- `wc -l skills/kiln-e2e/kiln-e2e.md` — should be ~250-350 lines

## SUMMARY
Create the file `skills/kiln-e2e/kiln-e2e.md`. This is a Claude Code skill definition — a markdown document with YAML frontmatter that provides patterns, protocols, and reference material for agents.

**Context for the implementer:** This skill is referenced by `agents/kiln-e2e-verifier.md` (T07-T01). It provides the test generation patterns that the E2E verifier uses to create user journey tests. It does NOT define agent behavior — it defines patterns and templates. The E2E verifier agent reads this skill for guidance on how to generate tests for each project type.

Start the file with this YAML frontmatter:

```yaml
---
name: kiln-e2e
description: "End-to-end test generation patterns, user journey format, and regression suite protocol"
---
```

Then write heading `# Kiln E2E Testing` followed by these sections:

### Section 1: User Journey Test Philosophy
Write heading `## User Journey Tests`. Explain:
- E2E tests in kiln are USER JOURNEYS, not unit tests or integration tests
- A journey simulates a real user's workflow from start to finish
- Each journey should map to one or more acceptance criteria from PLAN.md
- Journeys test BEHAVIOR, not implementation details
- Example contrast:
  - BAD (unit test): `expect(validateEmail('a@b.com')).toBe(true)`
  - BAD (integration test): `expect(db.users.count()).toBe(1)`
  - GOOD (journey): "User opens signup page, enters email and password, submits form, sees dashboard with welcome message"
- Journey naming convention: `journey-NN-descriptive-slug.test.{js,ts,sh}`

### Section 2: Web UI Test Patterns (Playwright)
Write heading `## Web UI: Playwright Patterns`. Provide:
- Playwright test template with proper setup/teardown using `test()` and `expect()` from `@playwright/test`
- Show a complete example test for a signup flow journey: navigate to /signup, fill email/password fields, click submit, assert dashboard visible, assert welcome text contains "Welcome"
- Navigation patterns: `page.goto()`, `page.click()`, `page.fill()`
- Assertion patterns: `toBeVisible()`, `toContainText()`, `toHaveURL()`
- Screenshot capture on failure: `page.screenshot({ path: 'artifacts/failure-NN.png' })`
- Wait strategies: `page.waitForSelector()`, `page.waitForURL()`, `page.waitForLoadState()`
- Anti-patterns: avoid `page.waitForTimeout()` (flaky), avoid testing CSS styles (brittle)

### Section 3: API Server Test Patterns (HTTP)
Write heading `## API Server: HTTP Patterns`. Provide:
- HTTP test template using native fetch for CRUD operations
- Show a complete example: POST to create resource, GET to retrieve, verify status codes and response body
- CRUD journey patterns: create, read, update, read, delete, verify-gone
- Auth flow patterns: register, login, use-token, access-protected, logout
- Error journey patterns: invalid input returns 400, unauthorized returns 401
- Response validation: status codes, response body structure, headers

### Section 4: CLI Tool Test Patterns (subprocess)
Write heading `## CLI Tool: Subprocess Patterns`. Provide:
- Subprocess test template using Node.js spawn/exec utilities to invoke CLI commands
- Show a complete example: init a project, build it, verify output files exist
- Journey patterns: init, configure, build, verify output
- Exit code validation
- Stderr capture for error journeys
- Working directory management for stateful CLI tools

### Section 5: Library Test Patterns (import)
Write heading `## Library: Import Patterns`. Provide:
- Import test template: require the library, create instance, call methods, verify results
- Journey patterns: create, configure, process, validate, cleanup
- Error handling journeys: invalid input triggers throw, edge cases handled gracefully
- Async library patterns: using async/await for promise-based APIs

### Section 6: Startup Detection Protocol
Write heading `## Startup Detection`. Define:
- Default timeout: 30 seconds (from `config.json preferences.e2eTimeout`)
- Detection methods by project type:
  - Web UI: HTTP GET to localhost until 200 response
  - API server: HTTP GET to health endpoint until 200
  - CLI: not applicable (no long-running process)
  - Library: not applicable (no long-running process)
- Polling interval: 500ms
- Timeout behavior: categorize as `config-issue`, include startup logs in failure report
- Custom health endpoint: configurable in config.json

### Section 7: Screenshot and Artifact Capture
Write heading `## Artifact Capture`. Define:
- Web UI: screenshot on every test failure, saved to `.kiln/tracks/phase-N/artifacts/`
- API: save response bodies for failed assertions
- CLI: save full stdout/stderr for failed commands
- All types: save test execution log

### Section 8: Regression Suite Growth
Write heading `## Regression Suite Protocol`. Define:
- Tests are organized by phase: `tests/e2e/phase-N/`
- Each new phase adds new journey tests
- ALL prior phase tests run as regression on every E2E cycle
- Test files are committed to git after successful E2E pass
- If regression tests fail after new code: categorize as `regression-bug`
- Regression suite pruning: operator can mark tests as deprecated between phases

Target ~300 lines.

## ESTIMATED_DIFF
~300 lines

## RISKS
- Test template examples may need adjustment for different project configurations
- Playwright dependency management across environments
- Regression suite may grow large for projects with many phases

## ROLLBACK
- git revert <task commit>
