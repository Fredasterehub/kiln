# T07-T03: Write reviewer agent

## GOAL
Write the kiln reviewer agent — an Opus 4.6-based comprehensive quality gate that reviews all code changes for a phase against the plan, vision, and living docs. It checks correctness, completeness, security, integration, stubs, quality, and regressions. On rejection, it generates correction tasks with file:line specificity that feed back through the execution pipeline.

## ACCEPTANCE_CRITERIA
- AC-03 (LLM): Reviewer checks all 7 dimensions: correctness, completeness, security, integration, stub detection, quality, regressions
- AC-04 (LLM): Stub detection covers: null-returning components, hardcoded API responses, no-op form handlers, unhandled fetch responses, console.log-only functions
- AC-05 (LLM): Failure categorization present for each dimension
- AC-06 (DET): File exists at `agents/kiln-reviewer.md` with valid YAML frontmatter
- AC-08 (LLM): Correction tasks include file:line specificity

## FILES
- path: agents/kiln-reviewer.md
  action: add
  rationale: The reviewer agent — comprehensive code review quality gate

## COMMANDS
- `test -f agents/kiln-reviewer.md` — file exists
- `head -1 agents/kiln-reviewer.md | grep -q "^---"` — has YAML frontmatter
- `wc -l agents/kiln-reviewer.md` — should be ~300-400 lines

## SUMMARY
Create the file `agents/kiln-reviewer.md`. This is a Claude Code agent definition — a markdown document with YAML frontmatter that defines the agent's role, model, tools, and behavioral rules.

**Context for the implementer:** Kiln is a multi-model orchestration workflow for Claude Code. The reviewer is the FINAL quality gate before documentation reconciliation. It runs after E2E tests pass and reviews the ENTIRE phase's code changes against the plan, vision, and living docs. It is spawned by the kiln orchestrator (see `agents/kiln-orchestrator.md`). Unlike the E2E verifier which tests runtime behavior, the reviewer checks code quality, architectural adherence, security, and completeness. On rejection, it generates correction tasks that flow back through the sharpen, implement, mini-verify, E2E pipeline — critically, corrections re-trigger E2E to ensure fixes don't break runtime behavior.

Start the file with this YAML frontmatter:

```yaml
---
name: kiln-reviewer
description: Comprehensive code review quality gate — checks correctness, completeness, security, integration, stubs, and quality
model: opus
tools:
  - Read
  - Write
  - Edit
  - Bash
  - Glob
  - Grep
---
```

Then write heading `# Kiln Reviewer` followed by these sections:

### Section 1: Role
Write heading `## Role`. Define the reviewer as:
- An Opus 4.6-based comprehensive quality gate
- Reviews the FULL git diff for the current phase (not just individual tasks)
- Cross-references changes against: PLAN.md (acceptance criteria), VISION.md (scope), living docs (patterns, decisions)
- Produces a verdict: APPROVED or REJECTED
- On rejection, generates correction tasks with file:line specificity
- References kiln-core for coordination contracts and sentinel schemas
- References kiln-verify skill for the adaptive verification protocol and stub detection patterns

### Section 2: Review Inputs
Write heading `## Review Inputs`. List what the reviewer reads:
- Full git diff for the current phase: `git diff <phase-start-commit>..HEAD`
- `.kiln/tracks/phase-N/PLAN.md` — acceptance criteria and task packets
- `.kiln/VISION.md` — scope and non-goals
- `.kiln/tracks/phase-N/e2e-results.md` — E2E test results (must be passing)
- `.kiln/docs/PATTERNS.md` — codebase conventions
- `.kiln/docs/DECISIONS.md` — architectural decisions
- `.kiln/docs/PITFALLS.md` — known gotchas to watch for

### Section 3: Review Dimensions
Write heading `## Review Dimensions`. Define 7 dimensions, each with specific checks:

**Dimension 1: Correctness** — Does the code implement what AC specifies? Check edge cases and error paths.

**Dimension 2: Completeness** — Are ALL AC addressed? Any TODO/FIXME left? All referenced modules implemented? Match VISION.md scope?

**Dimension 3: Security** — OWASP top 10 per project type. Input validation at boundaries. No hardcoded secrets. No injection vectors. No vulnerable deps.

**Dimension 4: Integration** — Components connect correctly? Imports/exports complete? API contracts match? Routes register?

**Dimension 5: Stub Detection** — Reference kiln-verify skill checklist. Components returning null unconditionally. Hardcoded API responses. No-op form handlers. Unhandled fetch responses. Console.log-only functions. Empty event handlers. Mock data in production code.

**Dimension 6: Quality** — Follows PATTERNS.md conventions. Consistent naming. No unnecessary duplication. Actionable error messages. Readable code.

**Dimension 7: Regressions** — E2E tests still pass (check e2e-results.md). Test suite passes (mini-verify). Removed code doesn't break consumers. API changes documented.

### Section 4: Verdict Protocol
Write heading `## Verdict`. Define:
- **APPROVED**: All 7 dimensions pass. Write `review-verdict` sentinel with `status: pass` and zero severity counts.
- **REJECTED**: One or more dimensions fail.
  - Each finding: dimension, severity (high/medium/low), file:line, description, suggested fix
  - Severity thresholds: any HIGH = rejected, 3+ MEDIUM = rejected, LOW = advisory only
  - Generate correction task packets for each HIGH and MEDIUM finding with goal, AC, file hints (exact file:line), error context
  - Write `review-verdict` sentinel with `status: fail`, severity counts, and `must_fix` list
- Sentinel format per kiln-core schema:
  - Required keys: sentinel, phase, status, reviewer, severity_high, severity_medium, severity_low
  - Recommended keys: must_fix, should_fix, notes, timestamp, diff_ref

### Section 5: Correction Loop
Write heading `## Correction Loop`. Define:
- Corrections flow through: sharpen, implement, mini-verify, E2E, review
- CRITICAL: corrections MUST re-trigger E2E (fixes can break runtime behavior)
- Max 3 review correction cycles (tracked in STATE.md)
- Each cycle gets the previous rejection context appended
- Acceptance criteria are NEVER weakened across cycles
- On cycle exhaustion: HALT with full context

### Section 6: Output Files
Write heading `## Output Files`. List:
- `.kiln/tracks/phase-N/review.md` — review findings and verdict (main output)
- Correction task packets (embedded in review.md when rejected)

### Section 7: Error Escalation
Write heading `## Error Escalation`. Reference kiln-core:
- Max 3 review correction cycles
- On exhaustion: HALT, save full error context to artifacts/
- Report: what failed, what was attempted, actionable next steps
- Operator decides: fix manually, adjust criteria, or replan

Target ~350 lines.

## ESTIMATED_DIFF
~350 lines

## RISKS
- Review quality depends heavily on the Opus model's judgment
- Stub detection false positives may generate unnecessary correction cycles
- File:line references may become stale if corrections modify the same files

## ROLLBACK
- git revert <task commit>
