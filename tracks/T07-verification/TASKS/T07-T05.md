# T07-T05: Write kiln-track skill

## GOAL
Write the kiln-track skill — the `/kiln:track` slash command that serves as the main work loop entry point. It auto-advances through the full track loop: plan, validate, execute, e2e, review, reconcile for each phase in the roadmap, and triggers the final integration E2E after all phases complete.

## ACCEPTANCE_CRITERIA
- AC-06 (DET): File exists at `skills/kiln-track/kiln-track.md` with valid YAML frontmatter
- AC-07 (LLM): Auto-advances through plan, validate, execute, e2e, review, reconcile
- AC-13 (LLM): References correct subagent spawning for each stage
- AC-14 (LLM): Defines pause conditions: reconcile confirmation, failures, operator halt
- AC-15 (LLM): Final integration E2E triggered after all phases complete

## FILES
- path: skills/kiln-track/kiln-track.md
  action: add
  rationale: The /kiln:track slash command — main work loop entry point

## COMMANDS
- `test -f skills/kiln-track/kiln-track.md` — file exists
- `head -1 skills/kiln-track/kiln-track.md | grep -q "^---"` — has YAML frontmatter
- `wc -l skills/kiln-track/kiln-track.md` — should be ~250-350 lines

## SUMMARY
Create the file `skills/kiln-track/kiln-track.md`. This is a Claude Code skill definition — a markdown document with YAML frontmatter that defines the `/kiln:track` slash command behavior.

**Context for the implementer:** This skill is the MAIN WORK LOOP for kiln. The operator runs `/kiln:track` and kiln automatically processes each phase from the roadmap through the full pipeline. The orchestrator agent (`agents/kiln-orchestrator.md`) uses this skill to determine what to do at each step. The skill defines the stage sequence, transition rules, pause conditions, and the final integration E2E. It references all other T07 agents/skills (E2E verifier, reviewer, verify skill) plus upstream agents (planners, executors, sharpener from T05/T06).

Start the file with this YAML frontmatter:

```yaml
---
name: kiln-track
description: "Main work loop — auto-advances phases through plan, validate, execute, e2e, review, reconcile"
user_invocable: true
---
```

Then write heading `# /kiln:track — Track Execution Loop` followed by these sections:

### Section 1: Overview
Write heading `## Overview`. Explain:
- `/kiln:track` is the main work loop that processes ROADMAP.md phases
- It reads the current state from STATE.md and advances to the next step
- The orchestrator agent executes this skill's logic
- The loop runs until all phases complete, then triggers final integration E2E
- Operator can interrupt at any pause point

### Section 2: Prerequisites
Write heading `## Prerequisites`. List what must exist before running:
- `.kiln/config.json` — project configuration (from /kiln:init)
- `.kiln/VISION.md` — approved vision (from /kiln:brainstorm)
- `.kiln/ROADMAP.md` — phase breakdown (from /kiln:roadmap)
- `.kiln/STATE.md` — initialized state tracking
- If any prerequisite is missing, print which one and instruct the operator to run the appropriate command

### Section 3: Track Loop Algorithm
Write heading `## Track Loop`. Define the algorithm as a numbered sequence:

1. Read STATE.md to determine current phase and step
2. If no current phase: pick first incomplete phase from ROADMAP.md
3. Execute current step for current phase:
   a. PLAN — spawn kiln-planner (Opus) plus kiln-codex-planner (if multi-model), then kiln-synthesizer (if multi-model)
   b. VALIDATE — spawn kiln-validator (Sonnet, 7-dimension check)
   c. EXECUTE — for each task wave in PLAN.md: spawn kiln-sharpener then kiln-executor then mini-verify; repeat for each wave in order
   d. E2E — spawn kiln-e2e-verifier (Sonnet)
   e. REVIEW — spawn kiln-reviewer (Opus)
   f. RECONCILE — run reconciliation protocol (kiln-reconcile skill)
4. After step completes: if PASS advance to next step and update STATE.md; if FAIL check correction budget, spawn corrections or HALT
5. After RECONCILE completes for a phase: mark phase complete in STATE.md, move to next incomplete phase; if no more phases trigger Final Integration E2E
6. After Final Integration E2E passes: generate FINAL_REPORT.md, mark project complete

### Section 4: Stage Details
Write heading `## Stage Details`. For each of the 6 stages, define:

**PLAN stage:** What agents to spawn (planner, codex-planner, synthesizer), multi-model vs claude-only behavior, expected output (PLAN.md with task packets).

**VALIDATE stage:** Spawn kiln-validator for 7-dimension check. On PASS proceed. On FAIL re-trigger planning with feedback.

**EXECUTE stage:** Parse task waves from PLAN.md. For each wave: sharpen then implement then mini-verify per task. Max 2 mini-verify retries. Waves execute sequentially, tasks within a wave can parallelize.

**E2E stage:** Spawn kiln-e2e-verifier. New journey tests plus cumulative regression. Max 3 correction cycles.

**REVIEW stage:** Spawn kiln-reviewer. APPROVED proceeds to reconcile. REJECTED generates corrections that flow through execute then E2E then review. Max 3 cycles.

**RECONCILE stage:** Run kiln-reconcile to update living docs. Present changes for operator confirmation. Update STATE.md.

### Section 5: Pause Conditions
Write heading `## Pause Conditions`. Define when the loop pauses:
1. After RECONCILE: operator confirms living doc changes
2. On any HALT: correction budget exhausted
3. On plan validation failure after 2 re-plan attempts
4. Operator can type "pause" at any time to stop after current step

### Section 6: Final Integration E2E
Write heading `## Final Integration E2E`. Define:
- Triggers after ALL roadmap phases complete
- Cross-cutting user journey tests spanning multiple phases
- Full regression suite (all phase tests)
- Max 3 correction cycles
- On PASS: generate FINAL_REPORT.md with scope delivered, open risks, test coverage, living doc status
- On FAIL after 3 cycles: HALT with full context

### Section 7: State Tracking
Write heading `## State Tracking`. Define STATE.md fields:
- currentPhase, currentStep
- correctionCycles (e2e, review, miniVerify counters)
- Phase progress table with status per phase
- Timestamps for each transition

Target ~300 lines.

## ESTIMATED_DIFF
~300 lines

## RISKS
- Track loop complexity — many state transitions to manage correctly
- State corruption could cause loops or skipped stages
- Final integration E2E may be hard to generate for complex multi-phase projects

## ROLLBACK
- git revert <task commit>
