# T08-T01: Write reconcile skill

## GOAL
Write the kiln reconcile skill — the living documentation update protocol that runs after each phase's code review passes. It reads what changed in the phase, updates the 4 living docs (TECH_STACK, PATTERNS, DECISIONS, PITFALLS), enforces a ~3000 word budget per doc, updates STATE.md, and checks if the roadmap still makes sense.

## ACCEPTANCE_CRITERIA
- AC-01 (LLM): Updates all 4 living docs: TECH_STACK.md, PATTERNS.md, DECISIONS.md, PITFALLS.md
- AC-02 (LLM): Budget enforcement at ~3000 words per doc, replace outdated entries not append
- AC-06 (DET): File exists at `skills/kiln-reconcile/kiln-reconcile.md` with valid YAML frontmatter
- AC-08 (LLM): STATE.md update protocol defined (mark phase complete, advance to next)
- AC-09 (LLM): Roadmap sanity check included (does roadmap still make sense after this phase?)

## FILES
- path: skills/kiln-reconcile/kiln-reconcile.md
  action: add
  rationale: Living documentation update protocol for the reconcile stage

## COMMANDS
- `test -f skills/kiln-reconcile/kiln-reconcile.md` — file exists
- `head -1 skills/kiln-reconcile/kiln-reconcile.md | grep -q "^---"` — has YAML frontmatter
- `wc -l skills/kiln-reconcile/kiln-reconcile.md` — should be ~250-350 lines

## SUMMARY
Create the file `skills/kiln-reconcile/kiln-reconcile.md`. This is a Claude Code skill definition — a markdown document with YAML frontmatter that defines the reconciliation protocol.

**Context for the implementer:** The reconcile stage runs after code review passes for each phase. Its purpose is to keep the living documentation current with what was actually built. In kiln, living docs are NOT documentation written once — they are actively maintained references that planners, implementers, and reviewers read. The reconcile skill defines WHAT to update and HOW. The orchestrator handles the reconcile stage directly (it doesn't spawn a separate reconcile agent). The operator must confirm proposed changes before they are applied.

Start the file with this YAML frontmatter:

```yaml
---
name: kiln-reconcile
description: "Living documentation update protocol — keeps TECH_STACK, PATTERNS, DECISIONS, PITFALLS current after each phase"
---
```

Then write heading `# Kiln Reconciliation Protocol` followed by these sections:

### Section 1: Purpose
Write heading `## Purpose`. Explain:
- Living docs are the project's institutional memory
- They are read by planners (to understand context), implementers (to follow conventions), reviewers (to check compliance)
- Reconcile keeps them accurate after each phase introduces changes
- Reconcile runs after REVIEW passes, before advancing to the next phase
- It is a PAUSE POINT — operator confirms changes

### Section 2: Reconcile Algorithm
Write heading `## Reconcile Steps`. Define the algorithm:

1. **Gather changes**: Read the git diff for the completed phase. Identify: new files, new dependencies, new patterns, architectural decisions, discovered pitfalls.
2. **Update TECH_STACK.md** (`.kiln/docs/TECH_STACK.md`):
   - Add new languages, frameworks, dependencies (with versions)
   - Remove deprecated/replaced dependencies
   - Update version numbers if changed
   - Format: structured sections (Languages, Frameworks, Dependencies, Build Tools, Runtime)
3. **Update PATTERNS.md** (`.kiln/docs/PATTERNS.md`):
   - Add new architecture patterns discovered/established in this phase
   - Add naming conventions that emerged
   - Add file structure patterns
   - Update patterns that changed
   - Format: pattern name, when to use, example reference (file path)
4. **Update DECISIONS.md** (`.kiln/docs/DECISIONS.md`):
   - Add ADR-format decision records for significant choices made during the phase
   - Each record: title, context, decision, consequences, date
   - Only add decisions that affect future phases (not trivial implementation choices)
5. **Update PITFALLS.md** (`.kiln/docs/PITFALLS.md`):
   - Add gotchas discovered during implementation, E2E, or review
   - Add anti-patterns that were corrected
   - Add environment-specific issues
   - Format: pitfall description, symptom, cause, fix
6. **Check roadmap**: Read `.kiln/ROADMAP.md`. After this phase, do remaining phases still make sense? If a phase should be reordered, split, or removed, note it for the operator.
7. **Update STATE.md**: Mark current phase as `complete`, advance currentPhase to next phase.
8. **Write reconcile log**: Save `.kiln/tracks/phase-N/reconcile.md` with a summary of all changes made.

### Section 3: Budget Enforcement
Write heading `## Budget Enforcement`. Define:
- Each living doc is capped at approximately 3000 words
- On each reconcile pass, check word count after updates
- If over budget: identify the OLDEST or LEAST RELEVANT entries and remove them
- Strategy: REPLACE outdated entries, don't just append
  - If a dependency was replaced, remove the old entry and add the new one
  - If a pattern evolved, update the existing entry instead of adding a duplicate
  - If a decision was superseded, mark the old one as superseded and add the new one
- Word count check: `wc -w .kiln/docs/<doc>.md` should be under 3500 (soft limit 3000, hard limit 3500)

### Section 4: Operator Confirmation Gate
Write heading `## Operator Confirmation`. Define:
- Present a summary of proposed changes to the operator:
  - Files modified and what changed in each
  - Any roadmap concerns
  - Word counts before and after
- Wait for explicit confirmation before applying changes
- On approval: apply changes, update STATE.md, write reconcile log
- On rejection: ask what to change, revise proposals, re-present

### Section 5: Reconcile Log Format
Write heading `## Reconcile Log`. Define the format for `.kiln/tracks/phase-N/reconcile.md`:
- Phase number and date
- Summary of what changed in the phase (files, deps, patterns)
- Living doc updates made (which docs, what was added/changed/removed)
- Budget status (word counts per doc)
- Roadmap assessment (still valid / concerns raised)
- Any unresolved doc debt (things that need updating but couldn't be done now)

### Section 6: Living Doc Schemas
Write heading `## Living Doc Schemas`. Define the required structure for each doc:

**TECH_STACK.md**: Languages (with versions), Frameworks, Dependencies (with versions), Build Tools, Runtime Targets, Development Tools

**PATTERNS.md**: Architecture Patterns, Naming Conventions, File Structure, Testing Patterns, Error Handling Patterns, API Patterns

**DECISIONS.md**: ADR format per entry — Title, Date, Status (accepted/superseded/deprecated), Context, Decision, Consequences

**PITFALLS.md**: Per entry — Title, Symptom, Cause, Fix, Severity (high/medium/low), Discovered (phase number)

Target ~300 lines.

## ESTIMATED_DIFF
~300 lines

## RISKS
- Budget enforcement may require subjective judgment about what to remove
- Operator confirmation adds a manual step that slows the pipeline
- Living doc quality depends on how well changes are analyzed

## ROLLBACK
- git revert <task commit>
