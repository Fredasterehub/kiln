# T08-T04: Write final integration E2E logic

## GOAL
Define the final integration E2E protocol that runs after ALL roadmap phases complete. This logic generates cross-cutting user journey tests that span multiple phases, runs the full regression suite, and produces FINAL_REPORT.md. This is embedded in the kiln-track skill or orchestrator as the terminal quality gate.

## ACCEPTANCE_CRITERIA
- AC-07 (LLM): Cross-cutting user journey test generation defined
- AC-14 (LLM): Full regression suite execution (all phase tests)
- AC-15 (LLM): FINAL_REPORT.md generation format defined
- AC-16 (LLM): Max 3 correction cycles, then halt with full context

## FILES
- path: skills/kiln-track/kiln-track.md
  action: modify
  rationale: Enhance the Final Integration E2E section with detailed protocol (or add as appendix)
- path: templates/FINAL_REPORT.md.tmpl
  action: add
  rationale: Template for the final project report

## COMMANDS
- `test -f templates/FINAL_REPORT.md.tmpl` — template exists
- `grep -q "Final Integration" skills/kiln-track/kiln-track.md` — kiln-track references final E2E

## SUMMARY
This task has TWO deliverables:

### Deliverable 1: Enhance kiln-track Final Integration E2E section

Modify `skills/kiln-track/kiln-track.md` (created in T07-T05) to expand the Final Integration E2E section with detailed protocol. If T07-T05 has already been written, add an appendix section. If not yet written, include these details in the instructions for T07-T05's Final Integration E2E section.

The enhanced section should define:

**Cross-Cutting Test Generation:**
- Read ALL phase PLAN.md files to collect the full set of acceptance criteria
- Identify cross-cutting user journeys that span 2+ phases:
  - Data flows: data created in phase 1 is visible/usable in phase 3
  - Auth flows: user authenticated in phase 1 can access features from all phases
  - Integration flows: components from different phases interact correctly
- Generate 3-5 critical cross-cutting journey tests (not exhaustive — focus on highest-risk paths)
- Cross-cutting tests go to `tests/e2e/integration/`

**Full Regression Execution:**
- Run ALL per-phase E2E tests from `tests/e2e/phase-*/`
- Run ALL cross-cutting integration tests from `tests/e2e/integration/`
- If any regression test fails: this is a CRITICAL bug (something that worked before is now broken)
- Regression failures get highest priority in correction tasks

**Correction Protocol:**
- Max 3 correction cycles for final integration E2E
- Corrections follow the same sharpen then implement then mini-verify then E2E pipeline
- After corrections, re-run the FULL integration suite (not just the failed tests)
- On cycle exhaustion: HALT with full context

**Success Criteria:**
- All per-phase regression tests pass
- All cross-cutting integration tests pass
- No new critical issues discovered

### Deliverable 2: Create FINAL_REPORT.md template

Create `templates/FINAL_REPORT.md.tmpl` with this structure:

```markdown
# Final Project Report

## Project Summary
- Project: {{projectName}}
- Phases completed: {{phaseCount}}
- Generated: {{timestamp}}

## Scope Delivered
{{#each phases}}
### Phase {{number}}: {{title}}
- Status: {{status}}
- Acceptance criteria: {{acMet}}/{{acTotal}} met
- Key deliverables: {{deliverables}}
{{/each}}

## Scope Deferred
{{#each deferredItems}}
- {{description}} — Reason: {{reason}}
{{/each}}

## Test Coverage
- Per-phase E2E tests: {{phaseTestCount}} ({{phaseTestPassed}} passed)
- Cross-cutting integration tests: {{integrationTestCount}} ({{integrationTestPassed}} passed)
- Regression suite total: {{totalTests}}

## Open Risks
{{#each risks}}
- **{{severity}}**: {{description}} — Mitigation: {{mitigation}}
{{/each}}

## Known Deviations
{{#each deviations}}
- {{description}} — Rationale: {{rationale}}
{{/each}}

## Living Documentation Status
- TECH_STACK.md: {{techStackWords}} words (budget: ~3000)
- PATTERNS.md: {{patternsWords}} words
- DECISIONS.md: {{decisionsWords}} words ({{decisionCount}} records)
- PITFALLS.md: {{pitfallsWords}} words ({{pitfallCount}} entries)

## Correction Cycle Summary
- Mini-verify retries: {{miniVerifyRetries}}
- E2E correction cycles: {{e2eCycles}}
- Review correction cycles: {{reviewCycles}}
- Halts encountered: {{haltCount}}

## Next Steps
{{#each nextSteps}}
- {{description}}
{{/each}}
```

Note: The `{{}}` placeholders use mustache-style syntax. The actual report generation will fill these from STATE.md, ROADMAP.md, and phase artifacts. The template is a GUIDE for the report structure — the generating agent reads the template and fills in real data.

Target: ~100 lines added to kiln-track + ~80 lines for FINAL_REPORT.md.tmpl.

## ESTIMATED_DIFF
~180 lines total

## RISKS
- Cross-cutting test generation is the hardest part — requires understanding relationships between phases
- FINAL_REPORT.md may not capture all relevant metrics
- This task depends on T07-T05 existing first

## ROLLBACK
- git revert <task commit>
