# T09-T02: Write on-session-start hook

## GOAL
Write the on-session-start shell script that rehydrates kiln state from .kiln/STATE.md when a new Claude Code session begins. It reads the state file, extracts the current phase and step, detects interrupted sessions, and outputs a summary so the orchestrator knows where to resume.

## ACCEPTANCE_CRITERIA
- AC-01 (DET): `shellcheck hooks/scripts/on-session-start.sh` passes
- AC-05 (LLM): Reads STATE.md and extracts current phase, step, and pending actions
- AC-05b (LLM): Detects interrupted sessions (in-progress status with stale timestamp)
- AC-05c (LLM): Provides resume instructions on output

## FILES
- path: hooks/scripts/on-session-start.sh
  action: add
  rationale: State rehydration hook for session continuity

## COMMANDS
- `test -f hooks/scripts/on-session-start.sh` — file exists
- `shellcheck hooks/scripts/on-session-start.sh` — passes shellcheck
- `test -x hooks/scripts/on-session-start.sh || head -1 hooks/scripts/on-session-start.sh | grep -q "^#!"` — executable or has shebang

## SUMMARY
Create the file `hooks/scripts/on-session-start.sh`. This is a POSIX shell script that runs at the start of every Claude Code session.

**Context for the implementer:** When a kiln session is interrupted (user closes terminal, context limit hit, etc.), the state in .kiln/STATE.md persists but the orchestrator loses its in-memory context. This hook provides a bridge — it reads STATE.md at session start and outputs a human/machine-readable summary that tells the orchestrator where to pick up. The output goes to stdout and is captured by Claude Code's hook system as additional context for the session.

Start the file with:
```sh
#!/bin/sh
# kiln on-session-start hook
# Rehydrates state from .kiln/STATE.md for session continuity
```

Then implement the following logic:

### 1. Check for .kiln/ directory
- If `.kiln/` does not exist: output "Kiln not initialized. Run /kiln:init to get started." and exit 0 (not an error)
- If `.kiln/STATE.md` does not exist: output "Kiln state missing. Run /kiln:init to reinitialize." and exit 0

### 2. Read STATE.md
- Parse the state file to extract key fields. STATE.md is markdown, so use grep/sed to extract:
  - Current phase (look for "currentPhase" or phase status markers)
  - Current step within phase (plan/validate/execute/e2e/review/reconcile)
  - Overall project status (in-progress, complete, halted)
  - Any correction cycle counts
- Use simple text parsing (grep, sed, awk) — no external dependencies

### 3. Detect interrupted sessions
- If the current step shows `in-progress` status, the previous session was likely interrupted
- Output a warning: "Previous session was interrupted during [phase] at [step] step."
- Include resume instructions: "Run /kiln:track to resume from the current step."

### 4. Output state summary
- Format the output as a brief, readable summary:
  ```
  [kiln] Session state rehydrated
  Project: [phase X of Y]
  Current step: [step name]
  Status: [in-progress|halted|complete]
  Next action: [what to do next]
  ```
- If project is complete: "Project complete. See .kiln/FINAL_REPORT.md"
- If halted: "Project halted at [step]. See .kiln/tracks/phase-N/ for details. Operator action needed."
- If in-progress: "Resume with /kiln:track"

### 5. Error handling
- All errors should fail gracefully (exit 0, not exit 1) — a hook failure should not block the session
- If STATE.md is malformed: output "Warning: STATE.md may be corrupted. Check .kiln/STATE.md manually."

**Shell scripting rules:**
- Use `#!/bin/sh` (POSIX), not `#!/bin/bash`
- No bashisms: no `[[`, no `(( ))`, no arrays, no `local` (use plain variable assignment)
- Quote all variable expansions: `"$var"` not `$var`
- Use `grep`, `sed`, `awk` for text parsing — these are standard POSIX utilities
- Keep it simple: this script should be under 80 lines

Target ~60-80 lines.

## ESTIMATED_DIFF
~80 lines

## RISKS
- STATE.md format may vary; parsing depends on consistent formatting
- Shell portability across macOS and Linux
- Hook output format must be compatible with Claude Code's hook system

## ROLLBACK
- git revert <task commit>
