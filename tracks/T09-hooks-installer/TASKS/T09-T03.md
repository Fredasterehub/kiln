# T09-T03: Write on-task-completed hook

## GOAL
Write the on-task-completed shell script that runs a mini-verify gate after each task completion in Claude Code. It reads the test command from .kiln/config.json, runs the project's test suite, and reports PASS/FAIL. On failure, it provides an error summary for retry context.

## ACCEPTANCE_CRITERIA
- AC-01 (DET): `shellcheck hooks/scripts/on-task-completed.sh` passes
- AC-06 (LLM): Reads test command from .kiln/config.json
- AC-06b (LLM): Runs the project's test suite
- AC-06c (LLM): Reports PASS/FAIL with error summary on failure

## FILES
- path: hooks/scripts/on-task-completed.sh
  action: add
  rationale: Mini-verify gate hook for post-task verification

## COMMANDS
- `test -f hooks/scripts/on-task-completed.sh` — file exists
- `shellcheck hooks/scripts/on-task-completed.sh` — passes shellcheck
- `test -x hooks/scripts/on-task-completed.sh || head -1 hooks/scripts/on-task-completed.sh | grep -q "^#!"` — executable or has shebang

## SUMMARY
Create the file `hooks/scripts/on-task-completed.sh`. This is a POSIX shell script that runs after each task/tool-use completion in Claude Code.

**Context for the implementer:** The mini-verify gate is a lightweight check that runs the project's test suite after each task to catch regressions early. It's much lighter than the full E2E verification — it just runs whatever test command is configured in .kiln/config.json. If tests fail, the output provides context for the next correction attempt. This hook is the first line of defense against broken code.

Start the file with:
```sh
#!/bin/sh
# kiln on-task-completed hook
# Runs mini-verify gate: executes project test suite after each task
```

Then implement the following logic:

### 1. Check for .kiln/ directory
- If `.kiln/` does not exist: exit 0 silently (kiln not initialized, nothing to verify)
- If `.kiln/config.json` does not exist: exit 0 silently

### 2. Read test command from config
- Parse `.kiln/config.json` to extract the `tooling.testRunner` field
- Use a simple approach: `grep` for the testRunner line, extract the value
- If no test runner configured (field is null or missing): output "[kiln] No test runner configured, skipping mini-verify" and exit 0
- The testRunner field contains the full command (e.g., "npm test", "pytest", "go test ./...")

### 3. Run the test suite
- Execute the test command captured from config
- Capture exit code, stdout (last 50 lines), and stderr (last 20 lines)
- Set a timeout (default 120 seconds) to prevent hanging tests from blocking the session

### 4. Report results
- On PASS (exit code 0):
  ```
  [kiln] Mini-verify: PASS
  ```
- On FAIL (non-zero exit code):
  ```
  [kiln] Mini-verify: FAIL
  Test command: <command>
  Exit code: <code>
  Last output:
  <truncated stdout/stderr>

  Fix the failing tests before proceeding.
  ```
- On TIMEOUT:
  ```
  [kiln] Mini-verify: TIMEOUT (exceeded 120s)
  Test command: <command>
  Consider increasing timeout or checking for hanging tests.
  ```

### 5. Error handling
- All errors fail gracefully (exit 0) — hook failures should not block the session
- If the test command is not found: output "[kiln] Warning: test command '<cmd>' not found" and exit 0
- Capture only truncated output to avoid flooding the session with test logs

**Shell scripting rules:**
- Use `#!/bin/sh` (POSIX), not `#!/bin/bash`
- No bashisms: no `[[`, no `(( ))`, no arrays
- Quote all variable expansions
- Use `grep`, `sed` for JSON parsing (simple field extraction, not full JSON parse)
- Keep it simple: under 80 lines
- Use `timeout` command if available, fall back to background process + sleep + kill if not

**Config.json parsing note:** The config.json is simple enough that grep-based extraction works:
```sh
test_cmd=$(grep -o '"testRunner"[[:space:]]*:[[:space:]]*"[^"]*"' .kiln/config.json | sed 's/.*: *"//;s/"$//')
```
This avoids requiring jq or python as dependencies.

Target ~60-80 lines.

## ESTIMATED_DIFF
~80 lines

## RISKS
- Test suite execution time may vary widely between projects
- grep-based JSON parsing is fragile for complex JSON structures
- Some test runners exit with non-zero for warnings, not just failures

## ROLLBACK
- git revert <task commit>
