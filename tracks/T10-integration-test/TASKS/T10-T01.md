# T10-T01: Write integration test script

## GOAL
Write the main integration test script that validates the complete kiln package installation flow. It creates a temp directory simulating a fresh Node.js project, runs the installer against it, and verifies that all files are placed correctly, .kiln/ is created, hooks are registered, and the installation is functional.

## ACCEPTANCE_CRITERIA
- AC-01 (DET): Installer runs against temp dir without errors
- AC-02 (DET): All 11 agent files exist in .claude/agents/ after install
- AC-03 (DET): All 7 skill directories exist in .claude/skills/ after install
- AC-04 (DET): hooks.json is valid JSON and references existing scripts
- AC-05 (DET): .kiln/ directory created with config.json and STATE.md

## FILES
- path: tests/integration.sh
  action: add
  rationale: Main integration test for the complete kiln package

## COMMANDS
- `test -f tests/integration.sh` — file exists
- `shellcheck tests/integration.sh` — passes shellcheck
- `bash tests/integration.sh` — all tests pass (exit 0)

## SUMMARY
Create the file `tests/integration.sh`. This is a bash test script that validates the complete kiln installation.

**Context for the implementer:** This is the CAPSTONE test for the entire kiln project. It validates that every component from tracks T01-T09 works together correctly. The test must be fully deterministic (no network calls, no flaky behavior) and clean up after itself (temp directory removed on exit).

Start the file with:
```bash
#!/usr/bin/env bash
set -euo pipefail

# Kiln integration test
# Validates: installation, file placement, .kiln/ creation, hooks registration

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PASS=0
FAIL=0
```

Then implement:

### Setup
- Create a temp directory: `TMPDIR=$(mktemp -d)`
- Set trap for cleanup: `trap 'rm -rf "$TMPDIR"' EXIT`
- Create a minimal Node.js project in temp dir:
  - `package.json` with name, version, and scripts (test: "echo test")
  - `src/index.js` with a placeholder
  - `node_modules/` (empty, just the directory)

### Test helper function
```bash
check() {
  local desc="$1"
  shift
  if "$@" >/dev/null 2>&1; then
    echo "  PASS: $desc"
    PASS=$((PASS + 1))
  else
    echo "  FAIL: $desc"
    FAIL=$((FAIL + 1))
  fi
}
```

### Test Group 1: Installation
- Run `node "$SCRIPT_DIR/bin/install.js" --repo-root "$TMPDIR" --yes`
- Check exit code is 0
- Check .claude/ directory exists
- Check .kiln/ directory exists

### Test Group 2: Agent files
- Check each expected agent file exists in `$TMPDIR/.claude/agents/`:
  - kiln-orchestrator.md
  - kiln-brainstormer.md
  - kiln-planner.md
  - kiln-codex-planner.md
  - kiln-synthesizer.md
  - kiln-validator.md
  - kiln-sharpener.md
  - kiln-executor.md
  - kiln-e2e-verifier.md
  - kiln-reviewer.md
  - kiln-researcher.md
- Count: should be 11 .md files in agents/

### Test Group 3: Skill directories
- Check each expected skill directory exists in `$TMPDIR/.claude/skills/`:
  - kiln-core/
  - kiln-init/
  - kiln-status/
  - kiln-quick/
  - kiln-brainstorm/
  - kiln-plan/
  - kiln-execute/
  - kiln-e2e/
  - kiln-verify/
  - kiln-track/
  - kiln-reconcile/
  - kiln-roadmap/
- Each directory should contain at least one .md file

### Test Group 4: Hooks
- Check `$TMPDIR/.claude/hooks/hooks.json` exists
- Check it's valid JSON: `python3 -c "import json; json.load(open('$TMPDIR/.claude/hooks/hooks.json'))"`
- Check hook scripts exist: on-session-start.sh, on-task-completed.sh
- Check scripts pass shellcheck (if shellcheck available)

### Test Group 5: .kiln/ structure
- Check `$TMPDIR/.kiln/config.json` exists and is valid JSON
- Check `$TMPDIR/.kiln/STATE.md` exists
- Check `$TMPDIR/.kiln/docs/` directory exists
- Check `$TMPDIR/.kiln/tracks/` directory exists

### Test Group 6: config.json content
- Check config.json has `projectType` field
- Check config.json has `modelMode` field
- Check config.json has `tooling` object

### Results
```bash
echo ""
echo "Results: $PASS passed, $FAIL failed"
if [ "$FAIL" -gt 0 ]; then
  exit 1
fi
echo "All integration tests passed!"
```

Target ~150 lines.

## ESTIMATED_DIFF
~150 lines

## RISKS
- Test depends on all upstream tracks being complete
- Temp directory cleanup may fail if tests create locked files
- shellcheck availability varies across environments

## ROLLBACK
- git revert <task commit>
