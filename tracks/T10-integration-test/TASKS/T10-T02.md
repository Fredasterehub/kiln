# T10-T02: Write cross-reference validation

## GOAL
Write a validation script (or section within integration.sh) that checks all cross-references between kiln agents and skills are valid. Every agent that references a skill must point to an existing skill. Every skill that references a template must point to an existing template. All model assignments must match the design spec.

## ACCEPTANCE_CRITERIA
- AC-06 (DET/LLM): Every agent reference to a skill resolves to an existing skill file
- AC-06b (DET): Every skill reference to a template resolves to an existing template file
- AC-06c (DET): Agent model assignments match the kiln-core routing table
- AC-06d (DET): Hooks reference existing scripts

## FILES
- path: tests/validate-refs.sh
  action: add
  rationale: Cross-reference validation for all kiln agents/skills/templates

## COMMANDS
- `test -f tests/validate-refs.sh` — file exists
- `shellcheck tests/validate-refs.sh` — passes shellcheck
- `bash tests/validate-refs.sh` — all validations pass

## SUMMARY
Create the file `tests/validate-refs.sh`. This script validates that all cross-references within the kiln package are consistent.

**Context for the implementer:** Kiln is a system of markdown agents and skills that reference each other by name. If an agent says "reference the kiln-brainstorm skill" but no file exists at `skills/kiln-brainstorm/kiln-brainstorm.md`, the system is broken. This validation script catches such inconsistencies. It runs against the SOURCE package (not an installed copy), checking the actual agent/skill/template files for cross-reference integrity.

Start the file with:
```bash
#!/usr/bin/env bash
set -euo pipefail

# Kiln cross-reference validation
# Checks: agent→skill refs, skill→template refs, model assignments, hook→script refs

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PASS=0
FAIL=0
WARN=0
```

Then implement:

### Validation 1: Agent-to-skill references
- For each agent file in `agents/*.md`:
  - Grep for skill references (patterns like "kiln-core", "kiln-brainstorm", "kiln-plan", etc.)
  - For each referenced skill name, check that `skills/<name>/<name>.md` exists
  - Report missing skills as FAIL

### Validation 2: Skill-to-template references
- For each skill file in `skills/*/*.md`:
  - Grep for template references (patterns like "templates/", ".tmpl")
  - For each referenced template, check that the file exists
  - Report missing templates as FAIL

### Validation 3: Model assignments
- Define expected model assignments from kiln-core:
  - orchestrator: opus
  - brainstormer: opus
  - planner: opus
  - codex-planner: sonnet
  - synthesizer: opus
  - validator: sonnet
  - sharpener: sonnet
  - executor: sonnet
  - e2e-verifier: sonnet
  - reviewer: opus
  - researcher: haiku
- For each agent, grep for "model:" in YAML frontmatter
- Compare against expected assignment
- Report mismatches as FAIL

### Validation 4: Hook-to-script references
- Parse hooks/hooks.json for script paths
- Check each referenced script exists
- Check scripts have proper shebang (#!/bin/sh or #!/usr/bin/env sh)
- Report missing scripts as FAIL

### Validation 5: File completeness
- Check expected file counts:
  - agents/*.md should be 11 files
  - skills/*/*.md directories should be 12 (or however many defined)
  - hooks/scripts/*.sh should be 2 files
  - templates/*.tmpl should have required templates
- Report missing files as FAIL

### Results
```bash
echo ""
echo "Cross-reference validation: $PASS passed, $FAIL failed, $WARN warnings"
if [ "$FAIL" -gt 0 ]; then
  exit 1
fi
echo "All cross-references valid!"
```

Target ~100 lines.

## ESTIMATED_DIFF
~100 lines

## RISKS
- Grep patterns for cross-references may miss non-standard reference formats
- Model assignment validation is brittle if routing table changes
- New agents/skills may not be covered by hardcoded checks

## ROLLBACK
- git revert <task commit>
